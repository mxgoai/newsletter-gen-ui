(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))n(o);new MutationObserver(o=>{for(const r of o)if(r.type==="childList")for(const c of r.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&n(c)}).observe(document,{childList:!0,subtree:!0});function s(o){const r={};return o.integrity&&(r.integrity=o.integrity),o.referrerPolicy&&(r.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?r.credentials="include":o.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function n(o){if(o.ep)return;o.ep=!0;const r=s(o);fetch(o.href,r)}})();function P(){return{form:document.getElementById("newsletter-form"),scheduleTypeSelect:document.getElementById("schedule-type"),specificDateTimeSection:document.getElementById("specific-datetime"),customRecurringSection:document.getElementById("custom-recurring"),weekdayButtons:document.querySelectorAll(".weekday-btn"),submitBtn:document.getElementById("submit-btn"),messageContainer:document.getElementById("message-container"),loginContainer:document.getElementById("login-container"),appContainer:document.getElementById("app-container"),loginBtn:document.getElementById("login-btn"),logoutBtn:document.getElementById("logout-btn"),userInfo:document.getElementById("user-info"),userEmail:document.getElementById("user-email"),plansLoginBtn:document.getElementById("plans-login-btn"),profileBtn:document.getElementById("profile-btn"),profileMenu:document.getElementById("profile-menu"),progressPercent:document.getElementById("progress-percent"),progressStatus:document.getElementById("progress-status"),progressCard:document.getElementById("progress-card"),progressBar:document.getElementById("progress-bar"),progressCheck:document.getElementById("progress-check"),successModal:document.getElementById("success-modal"),successModalCard:document.getElementById("success-modal-card"),successModalClose:document.getElementById("success-modal-close"),successModalDone:document.getElementById("success-modal-done"),successModalMessage:document.getElementById("success-modal-message"),successModalIds:document.getElementById("success-modal-ids")}}function U(){return{scheduleType:"immediate",selectedDays:[]}}function _(e){const t=localStorage.getItem(e);return typeof t=="string"?t:null}function R(){return{accessToken:_("accessToken"),refreshToken:_("refreshToken")}}function $(e,t,s){localStorage.setItem("accessToken",t),localStorage.setItem("refreshToken",s),e.accessToken=t,e.refreshToken=s}function F(e){localStorage.removeItem("accessToken"),localStorage.removeItem("refreshToken"),e.accessToken=null,e.refreshToken=null}function j(e,t,s="success"){e.messageContainer.textContent=t,e.messageContainer.className=`message-container ${s}`,e.messageContainer.classList.remove("hidden"),setTimeout(()=>{e.messageContainer.classList.add("hidden")},1e4)}function H(e,t){e.disabled=t,e.classList.toggle("btn-loading",t)}function v(e,t){const s=e.scheduleTypeSelect.value;t.scheduleType=s,e.specificDateTimeSection.classList.add("hidden"),e.customRecurringSection.classList.add("hidden"),s==="specific"?e.specificDateTimeSection.classList.remove("hidden"):s==="recurring"&&e.customRecurringSection.classList.remove("hidden")}function J(e,t){const s=parseInt(t.dataset.day,10);t.classList.toggle("active"),t.classList.contains("active")?e.selectedDays.includes(s)||e.selectedDays.push(s):e.selectedDays=e.selectedDays.filter(n=>n!==s)}function w(e,t){if(!e.progressPercent||!e.progressStatus)return;const s=document.getElementById("prompt")?.value.trim()||"",n=document.getElementById("read-time")?.value||"",o=e.scheduleTypeSelect?.value||"immediate",r=[s.length>0,n!==""&&Number(n)>0,!!o];if(o==="specific"){const a=document.getElementById("specific-date")?.value||"",p=document.getElementById("specific-time")?.value||"";r.push(a!==""&&p!=="")}o==="recurring"&&r.push(t.selectedDays.length>0);const c=r.filter(Boolean).length,d=r.length,i=d>0?Math.round(c/d*100):0;e.progressPercent.textContent=`${i}%`,i===0?e.progressStatus.textContent="Not started":i<100?e.progressStatus.textContent="In progress":e.progressStatus.textContent="Complete",e.progressBar&&(e.progressBar.style.width=`${i}%`),e.progressCard&&e.progressCard.classList.toggle("complete",i===100),e.progressCheck&&e.progressCheck.classList.toggle("hidden",i!==100)}function q(e){return Array.isArray(e?.scheduled_task_ids)&&e.scheduled_task_ids.length>0?e.scheduled_task_ids:e?.task_id?[e.task_id]:e?.newsletter_id?[e.newsletter_id]:e?.id?[e.id]:[]}function Y(e){if(navigator?.clipboard?.writeText)return navigator.clipboard.writeText(e);const t=document.createElement("textarea");return t.value=e,t.setAttribute("readonly","true"),t.style.position="absolute",t.style.left="-9999px",document.body.appendChild(t),t.select(),document.execCommand("copy"),document.body.removeChild(t),Promise.resolve()}function z(e){e.successModal&&(e.successModal.classList.add("hidden"),e.successModal.classList.remove("flex"),document.body.style.overflow="")}function W(e,t){if(!e.successModal||!e.successModalMessage||!e.successModalIds)return;const n=!!t?.is_scheduled?"Newsletter scheduled":"Newsletter created",o=t?.sample_email_sent?"A sample email has been sent to your inbox.":"Your newsletter request was submitted successfully.",r=e.successModalCard?.querySelector("h3");r&&(r.textContent=n),e.successModalMessage.textContent=o;const c=q(t);if(e.successModalIds.innerHTML="",c.length>0){const d=document.createElement("p");d.className="text-[11px] uppercase tracking-[0.25em] text-gray-400 font-semibold",d.textContent=c.length>1?"Task IDs":"Task ID",e.successModalIds.appendChild(d),c.forEach(i=>{const a=document.createElement("div");a.className="flex items-center justify-between gap-3 bg-gray-50 border border-gray-100 rounded-2xl px-4 py-3";const p=document.createElement("span");p.className="text-[12px] font-semibold text-gray-700 break-all",p.textContent=i;const g=document.createElement("button");g.type="button",g.className="w-9 h-9 rounded-full border border-gray-200 flex items-center justify-center text-gray-500 hover:text-gray-900 hover:border-gray-300 transition",g.innerHTML='<span class="material-symbols-outlined text-[18px]">content_copy</span>',g.addEventListener("click",async()=>{try{await Y(i),g.innerHTML='<span class="material-symbols-outlined text-[18px]">check</span>',setTimeout(()=>{g.innerHTML='<span class="material-symbols-outlined text-[18px]">content_copy</span>'},1200)}catch(h){console.error("Copy failed:",h)}}),a.appendChild(p),a.appendChild(g),e.successModalIds.appendChild(a)})}e.successModal.classList.remove("hidden"),e.successModal.classList.add("flex"),document.body.style.overflow="hidden"}function N(e){try{const s=e.split(".")[1].replace(/-/g,"+").replace(/_/g,"/"),n=decodeURIComponent(atob(s).split("").map(function(o){return"%"+("00"+o.charCodeAt(0).toString(16)).slice(-2)}).join(""));return JSON.parse(n)}catch(t){return console.error("Failed to parse JWT",t),null}}function D(e){const t=N(e);return!t||!t.exp?0:t.exp*1e3}function G(e,t){if(t.accessToken){e.loginBtn.classList.add("hidden"),e.submitBtn.classList.remove("hidden"),e.userInfo.classList.remove("hidden"),e.plansLoginBtn&&e.plansLoginBtn.classList.add("hidden");const s=N(t.accessToken);s&&s.email&&(e.userEmail.textContent=`Logged in as: ${s.email}`),e.loginContainer.classList.add("hidden"),e.appContainer.classList.add("hidden")}else e.loginBtn.classList.remove("hidden"),e.submitBtn.classList.add("hidden"),e.userInfo.classList.add("hidden"),e.userEmail.textContent="",e.profileMenu&&e.profileMenu.classList.add("hidden"),e.plansLoginBtn&&e.plansLoginBtn.classList.remove("hidden"),e.loginContainer.classList.add("hidden"),e.appContainer.classList.add("hidden")}let E=null;function K(){return{URL:"https://qwkjjtvoopwtmqfbugqz.supabase.co",ANON_KEY:"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF3a2pqdHZvb3B3dG1xZmJ1Z3F6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDI5MTI3ODcsImV4cCI6MjA1ODQ4ODc4N30.B7K9jtgeDLnFNFdfY1OluonVW8lRKtZ82_9_zbc7M6M"}}async function Z(e,t,s,n=!1){const o=e.accessToken,r=e.refreshToken;if(!r)return!1;const c=o?D(o):0,d=Date.now();if(!n&&c&&c-d>6e4)return!0;const i=K();try{const a=await fetch(`${i.URL}/auth/v1/token?grant_type=refresh_token`,{method:"POST",headers:{"Content-Type":"application/json",apikey:i.ANON_KEY,Authorization:`Bearer ${i.ANON_KEY}`},body:JSON.stringify({refresh_token:r})});if(!a.ok)return s(),!1;const p=await a.json();return!p?.access_token||!p?.refresh_token?(s(),!1):(t(p.access_token,p.refresh_token),!0)}catch(a){return console.error("Failed to refresh Supabase session:",a),!!e.accessToken}}function L(e,t,s,n=!1){if(E&&clearTimeout(E),E=null,n)return;const o=e.accessToken;if(!o)return;const r=D(o);if(!r)return;const c=Date.now(),d=Math.max(5e3,r-c-6e4);E=setTimeout(()=>{t(!0).catch(()=>{s()})},d)}const b="https://www.mxgo.ai",V=`${b}/auth/extension-bridge`,X=`${b}/auth/extension-logout`;let y=null;function Q(e){if(!e||e?.type&&e.type!=="MX_AUTH_SESSION"&&e.type!=="auth-token")return null;const t=e.payload||e.auth||e.tokens||null,s=t?.access_token||t?.accessToken||e?.access_token||e?.accessToken||null,n=t?.refresh_token||t?.refreshToken||e?.refresh_token||e?.refreshToken||null;return!s||!n?null:{accessToken:s,refreshToken:n}}function C(){if(y&&!y.closed){y.focus();return}const e=window.location.origin,t=`${V}?opener_origin=${encodeURIComponent(e)}`;y=window.open(t,"authWindow","width=520,height=680,resizable=yes,scrollbars=yes")}function ee({saveTokens:e,clearTokens:t,cleanupLogoutFrame:s,showMessage:n}){return function(r){if(r.origin!==b||r.data?.source&&r.data.source!=="mxgo"||y&&r.source&&r.source!==y)return;if(r.data?.type==="MX_WEB_LOGOUT_COMPLETE"){t(),s();return}const c=Q(r.data);if(c){e(c.accessToken,c.refreshToken),n("Logged in successfully!","success");try{y&&!y.closed&&y.close()}catch(d){console.error("Failed to close auth popup window:",d)}y=null}}}let u=null,I=null;function B(){I&&clearTimeout(I),I=null,u&&u.parentNode&&u.parentNode.removeChild(u),u=null}function te(e,t,s,n,o){s(),n(),o("You have been logged out.","success"),B();const r=window.location.origin,c=`${X}?opener_origin=${encodeURIComponent(r)}`;u=document.createElement("iframe"),u.src=c,u.title="mxgo-logout",u.setAttribute("aria-hidden","true"),u.style.width="0",u.style.height="0",u.style.border="0",u.style.position="fixed",u.style.left="-9999px",u.style.top="-9999px",u.style.opacity="0",u.style.pointerEvents="none",document.body.appendChild(u),I=setTimeout(()=>{B()},4e3)}const M="http://20.198.253.249:8000",x={CREATE_NEWSLETTER:"/create-newsletter"};function se(){return crypto.randomUUID()}function ne(e,t){return!e||!t?null:new Date(`${e}T${t}`).toISOString()}function oe(e,t){if(!e||e.length===0||!t)return{days:[],time:null};const[s,n]=t.split(":").map(Number),o=new Set;let r="";const c=new Date;return e.forEach((d,i)=>{const a=new Date(c),p=c.getDay()===0?6:c.getDay()-1,g=(d-p+7)%7;a.setDate(c.getDate()+g),a.setHours(s,n,0,0);const h=a.getUTCDay()===0?6:a.getUTCDay()-1;if(o.add(h),i===0){const l=a.getUTCHours(),f=a.getUTCMinutes();r=`${String(l).padStart(2,"0")}:${String(f).padStart(2,"0")}`}}),{days:Array.from(o).sort(),time:r}}function re(e){switch(e.scheduleType){case"immediate":return{type:"IMMEDIATE",specific_datetime:null,weekly_schedule:null};case"specific":{const t=document.getElementById("specific-date").value,s=document.getElementById("specific-time").value;return{type:"SPECIFIC_DATES",specific_datetime:ne(t,s),weekly_schedule:null}}case"recurring":{const t=document.getElementById("recurring-time").value||"09:00",s=oe(e.selectedDays,t);return{type:"RECURRING_WEEKLY",specific_datetime:null,weekly_schedule:{days:s.days,time:s.time}}}default:return{type:"IMMEDIATE",specific_datetime:null,weekly_schedule:null}}}function ce(e){const t=parseInt(e,10);return Number.isNaN(t)||t===0?null:t}function ie(e){const t=document.getElementById("sources").value.trim().split(",").map(n=>n.trim()).filter(n=>n.length>0),s=document.getElementById("locations").value.trim().split(",").map(n=>n.trim()).filter(n=>n.length>0);return{request_id:se(),prompt:document.getElementById("prompt").value.trim(),estimated_read_time:ce(document.getElementById("read-time").value),sources:t.length>0?t:null,geographic_locations:s.length>0?s:null,formatting_instructions:null,schedule:re(e)}}function ae(e,t){if(!document.getElementById("prompt").value.trim())return t("Please enter a newsletter prompt.","error"),!1;if(!document.getElementById("read-time").value)return t("Please enter an estimated read time.","error"),!1;if(e.scheduleType==="specific"){const s=document.getElementById("specific-date").value,n=document.getElementById("specific-time").value;if(!s||!n)return t("Please select both a date and time for specific scheduling.","error"),!1;if(new Date(`${s}T${n}`)<new Date)return t("The scheduled date and time must be in the future.","error"),!1}return e.scheduleType==="recurring"&&e.selectedDays.length===0?(t("Please select at least one day for a recurring schedule.","error"),!1):!0}function le(e,t,s){let n=t.is_scheduled?"Newsletter scheduled successfully!":"Newsletter generated successfully!";t.scheduled_task_ids?.length>0&&(n+=` Task IDs: ${t.scheduled_task_ids.join(", ")}`),t.sample_email_sent&&(n+=" A sample email has been sent."),e(n,"success"),s&&s(t)}function de(e,t,s,n){let o=n.detail?.message||n.detail||"An error occurred. Please try again.";switch(s){case 401:o="Your session has expired. Please log in again.",t();break;case 403:o="You have reached the newsletter limit for your plan.";break;case 409:o="This request has already been processed.";break}e(o,"error")}function ue({state:e,session:t,setButtonLoading:s,showMessage:n,showSuccessModal:o,refreshSessionIfNeeded:r,handleLogout:c}){return async function(i){if(ae(e,n)){s(i,!0);try{if(!await r(!1)){n("Authentication required. Please log in.","error"),c(),s(i,!1);return}const p=ie(e),g=t.accessToken;if(!g){n("Authentication required. Please log in.","error"),c(),s(i,!1);return}let h=await fetch(`${M}${x.CREATE_NEWSLETTER}`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${g}`},body:JSON.stringify(p)});if(h.status===401){if(!await r(!0)||!t.accessToken){n("Your session has expired. Please log in again.","error"),c(),s(i,!1);return}h=await fetch(`${M}${x.CREATE_NEWSLETTER}`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t.accessToken}`},body:JSON.stringify(p)})}const l=await h.json();h.ok?le(n,l,o):de(n,c,h.status,l)}catch(a){console.error("Error submitting newsletter:",a),n("Network error. Please check your connection and try again.","error")}finally{s(i,!1)}}}}function pe(){const e=P(),t=U(),s=R();function n(l,f="success"){j(e,l,f)}function o(){G(e,s)}function r(l,f){$(s,l,f),o(),L(s,d,c,!1)}function c(){F(s),o(),L(s,d,c,!0)}async function d(l=!1){return Z(s,(f,k)=>r(f,k),()=>c(),l)}function i(){te(e,s,()=>c(),()=>o(),(l,f)=>n(l,f))}const a=ue({state:t,session:s,setButtonLoading:H,showMessage:n,showSuccessModal:l=>W(e,l),refreshSessionIfNeeded:d,handleLogout:i}),p=ee({saveTokens:r,clearTokens:c,cleanupLogoutFrame:B,showMessage:n});function g(){const l=()=>w(e,t);if(e.scheduleTypeSelect.addEventListener("change",()=>{v(e,t),l()}),e.weekdayButtons.forEach(m=>{m.addEventListener("click",()=>{J(t,m),l()})}),e.submitBtn.addEventListener("click",()=>a(e.submitBtn)),e.loginBtn.addEventListener("click",C),e.logoutBtn.addEventListener("click",i),e.plansLoginBtn&&e.plansLoginBtn.addEventListener("click",C),e.profileBtn&&e.profileMenu&&(e.profileBtn.addEventListener("click",m=>{m.stopPropagation();const T=e.profileMenu.classList.contains("hidden");e.profileMenu.classList.toggle("hidden",!T),e.profileBtn.setAttribute("aria-expanded",String(T))}),document.addEventListener("click",()=>{e.profileMenu.classList.add("hidden"),e.profileBtn.setAttribute("aria-expanded","false")}),e.profileMenu.addEventListener("click",m=>{m.stopPropagation()})),e.successModal){const m=()=>z(e);e.successModalClose?.addEventListener("click",m),e.successModalDone?.addEventListener("click",m),e.successModal.addEventListener("click",T=>{T.target===e.successModal&&m()})}window.addEventListener("message",p),e.form.addEventListener("submit",m=>m.preventDefault());const f=document.getElementById("prompt"),k=document.getElementById("read-time"),A=document.getElementById("specific-date"),O=document.getElementById("specific-time");function S(){if(!f)return;const m=f.value.trim().length>0;f.classList.toggle("ring-4",!m),f.classList.toggle("ring-blue-100",!m)}f?.addEventListener("input",()=>{l(),S()}),k?.addEventListener("input",l),A?.addEventListener("change",l),O?.addEventListener("change",l),S()}function h(){g(),v(e,t),w(e,t),o(),L(s,d,c,!1)}h()}document.addEventListener("DOMContentLoaded",pe);
